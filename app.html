<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Planner</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planner">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
      html, body { height: 100%; margin: 0; }
      #app { display: grid; grid-template-columns: 280px 1fr; height: 100%; }
      #topbar { display: none; align-items: center; gap: 8px; padding: 10px; border-bottom: 1px solid #eee; }
      #sidebar { padding: 10px; border-right: 1px solid #ddd; overflow: auto; background: #fff; overscroll-behavior: contain; }
      #tactical-map { width: 100%; height: 100%; position: relative; }
      .section { margin-bottom: 14px; }
      .grid-info { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 20px; }
      .palette { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
      .unit-item { display: flex; flex-direction: column; align-items: center; padding: 6px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; }
      .hierarchy { max-height: 200px; overflow: auto; border: 1px solid #ddd; padding: 6px; border-radius: 4px; }
      .controls button { margin: 2px 0; width: 100%; }
      .route { border-top: 1px solid #eee; padding-top: 10px; }
      .context-menu { position: absolute; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 2000; }
      .context-menu-item { padding: 8px 12px; cursor: pointer; }
      .context-menu-item:hover { background: #f5f5f5; }

      /* Mobile layout (iPhone 13 friendly) */
      @media (max-width: 820px) {
        #app { grid-template-columns: 1fr; }
        #topbar { display: flex; padding-top: calc(env(safe-area-inset-top, 0px) + 10px); }
        #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 85%; max-width: 360px; z-index: 3000; border-right: 1px solid #ddd; transform: translateX(-100%); transition: transform 0.25s ease; box-shadow: 2px 0 12px rgba(0,0,0,0.15); }
        #sidebar.open { transform: translateX(0); }
        /* Use dynamic viewport to avoid Safari 100vh issues */
        .map-wrapper { position: relative; height: calc(var(--app-vh, 1vh) * 100 - 48px - env(safe-area-inset-bottom, 0px)); padding-bottom: env(safe-area-inset-bottom, 0px); }
        /* Larger touch targets */
        button, input { font-size: 16px; }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="sidebar">
        <div class="section">
          <label><strong>Go To (MGRS)</strong></label>
          <div style="display:flex; gap:6px;">
            <input id="mgrs-input" type="text" placeholder="17S KT 85128 53610" style="flex:1;">
            <button id="goto-location">Go</button>
          </div>
        </div>

        <div class="section controls">
          <button id="measure-distance">Measure Distance</button>
          <button id="add-text">Add Text</button>
          <button id="export-image">Export Image</button>
          <button id="clear-units">Clear Units</button>
        </div>

        <div class="section">
          <strong>Text Formatting</strong>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:6px;">
            <label>Text<br><input id="text-color" type="color" value="#000000"></label>
            <label>Background<br><input id="text-bg-color" type="color" value="#ffffff"></label>
          </div>
          <div style="margin-top:6px;">
            <label>Size <input id="text-size" type="range" min="10" max="36" value="14" style="width:100%"></label>
          </div>
        </div>

        <div class="section">
          <strong>Unit Palette</strong>
          <div id="unit-palette" class="palette"></div>
        </div>

        <div class="section">
          <strong>Unit Hierarchy</strong>
          <div id="unit-hierarchy" class="hierarchy"></div>
        </div>

        <div class="section route">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Route Plan</strong>
            <button id="add-route-leg" style="padding:2px 6px;">Add Leg</button>
          </div>
          <div id="route-plan-list" style="margin-top:8px;">
            <div class="route-leg" data-leg="1">
              <input type="text" class="route-from" placeholder="From" style="width: 45px;">
              <span>→</span>
              <input type="text" class="route-to" placeholder="To" style="width: 45px;">
              <span>(</span>
              <input type="number" class="route-distance" placeholder="m" style="width: 50px;">
              <span>m,</span>
              <input type="number" class="route-azimuth" placeholder="°" style="width: 50px;">
              <span>°,</span>
              <input type="text" class="route-direction" placeholder="dir" style="width: 30px;">
              <span>)</span>
              <button class="route-notes-btn" style="margin-left: 3px; padding: 1px 4px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">+</button>
              <button class="route-remove-btn" style="margin-left: 3px; padding: 1px 4px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">-</button>
            </div>
            <div class="route-notes" style="display: none; margin-top: 5px; margin-bottom: 8px;">
              <textarea class="route-notes-text" placeholder="Enter notes for this route leg..." style="width: 100%; height: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
            </div>
          </div>
          <div style="display:none; gap:6px; margin-top:8px;">
            <button id="save-route-plan">Save</button>
            <button id="load-route-plan">Load</button>
            <button id="clear-route-plan">Clear</button>
          </div>
        </div>

        <div class="section">
          <strong>Your Location</strong>
          <div id="your-location-mgrs" style="padding:6px; border:1px solid #ddd; border-radius:4px; margin-top:6px;">—</div>
          <button id="refresh-location" style="margin-top:6px; width:100%;">Refresh Location</button>
        </div>
      </div>

      <div style="display:flex; flex-direction:column;">
        <div id="topbar">
          <button id="toggle-sidebar">☰</button>
          <div style="font-weight:bold;">Tactical Planner</div>
        </div>
        <div class="map-wrapper" style="position:relative; height:100%;">
          <div id="sidebar-overlay" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.25); z-index:2000;"></div>
        <div class="grid-info">
          <div id="grid-info">Grid: 1km</div>
          <div id="cursor-position">MGRS: —</div>
        </div>
        <div id="tactical-map"></div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mgrs@2.1.0/dist/mgrs.min.js"></script>
    <script>window.mgrs = mgrs;</script>
    <script src="public/js/app-core.js?v=debug"></script>
    <script>
      // Register service worker for PWA/offline and standalone fullscreen
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      }
      // iOS Safari 100vh fix: set --app-vh to innerHeight
      (function setVh(){
        var set = function(){ document.documentElement.style.setProperty('--app-vh', (window.innerHeight*0.01)+'px'); };
        set();
        window.addEventListener('resize', set);
        window.addEventListener('orientationchange', set);
      })();
      // Sidebar toggle for mobile
      (function(){
        var btn = document.getElementById('toggle-sidebar');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('sidebar-overlay');
        function openSidebar(){ sidebar.classList.add('open'); if (overlay) overlay.style.display='block'; }
        function closeSidebar(){ sidebar.classList.remove('open'); if (overlay) overlay.style.display='none'; }
        if (btn && sidebar) btn.addEventListener('click', function(){
          if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
        });
        if (overlay) overlay.addEventListener('click', closeSidebar);
        // Swipe gestures
        var startX=0, startY=0, tracking=false;
        window.addEventListener('touchstart', function(e){
          var t=e.touches[0]; startX=t.clientX; startY=t.clientY; tracking=true;
        }, {passive:true});
        window.addEventListener('touchmove', function(e){
          if(!tracking) return;
        }, {passive:true});
        window.addEventListener('touchend', function(e){
          if(!tracking) return; tracking=false; var dx=(e.changedTouches[0].clientX - startX); var dy=Math.abs(e.changedTouches[0].clientY - startY);
          if (dy < 80) {
            // Open if swipe right from left edge
            if (!sidebar.classList.contains('open') && startX < 24 && dx > 60) { openSidebar(); }
            // Close if swipe left while open
            if (sidebar.classList.contains('open') && dx < -60) { closeSidebar(); }
          }
        }, {passive:true});
      })();
    </script>
  </body>
</html>


