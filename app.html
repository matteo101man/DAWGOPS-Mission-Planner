<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Planner</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planner">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
      html, body { height: 100%; margin: 0; }
      /* Disable selection on iOS to avoid accidental highlights */
      html, body, #app { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
      /* Allow selection inside editable text markers */
      .text-marker, .text-marker * { -webkit-user-select: text; user-select: text; -webkit-touch-callout: default; }
      /* Unit marker styling */
      .unit-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .unit-label {
        background: rgba(255, 255, 255, 0.9);
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        white-space: nowrap;
        margin-bottom: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      }
      .unit-controls {
        display: flex;
        gap: 4px;
        margin-top: 4px;
        flex-wrap: wrap;
        justify-content: center;
      }
      /* Unit bounding box for touch-friendly interaction */
      .unit-bounding-box {
        cursor: move;
        touch-action: none; /* Prevent default touch behaviors */
        pointer-events: auto !important; /* Ensure it captures touches */
      }
      /* Live location marker with pulsing animation */
      .live-location-marker .pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 3px solid #4285F4;
        border-radius: 50%;
        animation: pulse 2s ease-out infinite;
        opacity: 0;
      }
      @keyframes pulse {
        0% {
          transform: translate(-50%, -50%) scale(0.5);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1.5);
          opacity: 0;
        }
      }
      #app { display: grid; grid-template-columns: 280px 1fr; height: 100%; }
      #topbar { display: none; align-items: center; gap: 8px; padding: 10px; border-bottom: 1px solid #eee; }
      #sidebar { 
        padding: 10px; 
        border-right: 1px solid rgba(0,0,0,0.1); 
        overflow-y: auto; 
        overflow-x: hidden;
        background: rgba(255, 255, 255, 0.85); 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        overscroll-behavior: contain; 
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: rgba(0,0,0,0.3) transparent;
      }
      #sidebar::-webkit-scrollbar { width: 8px; }
      #sidebar::-webkit-scrollbar-track { background: transparent; }
      #sidebar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.3); border-radius: 4px; }
      #sidebar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.5); }
      #tactical-map { width: 100%; height: 100%; position: relative; }
      .section { margin-bottom: 14px; }
      .grid-info { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 20px; }
      .palette { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .unit-item { 
        display: flex; flex-direction: column; align-items: center; 
        padding: 10px 6px; 
        border: 1px solid #ddd; 
        border-radius: 8px; 
        background: #fafafa; 
        min-height: 80px;
        cursor: pointer;
        transition: all 0.15s ease;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      .unit-item:active { background: #e8e8e8; transform: scale(0.95); }
      .hierarchy { 
        max-height: 300px; 
        overflow-y: auto; 
        overflow-x: hidden;
        border: 1px solid rgba(0,0,0,0.1); 
        padding: 8px; 
        border-radius: 8px; 
        background: rgba(255,255,255,0.5);
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: rgba(0,0,0,0.3) transparent;
      }
      .hierarchy::-webkit-scrollbar { width: 6px; }
      .hierarchy::-webkit-scrollbar-track { background: transparent; }
      .hierarchy::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.3); border-radius: 3px; }
      .hierarchy-list { list-style: none; padding: 0; margin: 0; }
      .hierarchy-item { 
        padding: 8px 10px; 
        margin: 4px 0; 
        border-radius: 6px; 
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.15s ease;
      }
      .hierarchy-item:active { background: rgba(0,0,0,0.05); }
      .hierarchy-item.selected { background: rgba(52, 152, 219, 0.2); border-color: rgba(52, 152, 219, 0.4); }
      .hierarchy-icon { 
        width: 24px; 
        height: 24px; 
        object-fit: contain; 
        display: inline-block; 
        vertical-align: middle; 
        margin-right: 8px;
      }
      .hierarchy-unit { 
        display: flex; 
        align-items: center; 
        justify-content: space-between;
      }
      .hierarchy-name { 
        flex: 1; 
        font-size: 13px; 
        vertical-align: middle;
      }
      .controls button { 
        margin: 4px 0; 
        width: 100%; 
        min-height: 44px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        font-size: 15px;
        -webkit-tap-highlight-color: transparent;
        transition: all 0.15s ease;
        touch-action: manipulation;
      }
      .controls button:active { background: #f0f0f0; transform: scale(0.98); }
      .route { border-top: 1px solid #eee; padding-top: 10px; }
      .context-menu { position: absolute; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 2000; }
      .context-menu-item { padding: 8px 12px; cursor: pointer; }
      .context-menu-item:hover { background: #f5f5f5; }

      /* Mobile layout (iPhone 13 friendly) */
      @media (max-width: 820px) {
        #app { grid-template-columns: 1fr; }
        #topbar { display: flex; padding-top: calc(env(safe-area-inset-top, 0px) + 10px); }
        #sidebar { 
          position: fixed; 
          top: 0; 
          left: 0; 
          height: 100%; 
          width: 50%; 
          max-width: 300px; 
          z-index: 3000; 
          border-right: 1px solid rgba(0,0,0,0.1); 
          transform: translateX(-100%); 
          transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
          box-shadow: 2px 0 12px rgba(0,0,0,0.15); 
          padding-bottom: env(safe-area-inset-bottom, 0px);
          background: rgba(255, 255, 255, 0.85);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          -webkit-overflow-scrolling: touch;
          touch-action: pan-y;
          pointer-events: auto;
        }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.3);
          z-index: 2999;
          display: none;
          touch-action: none;
          pointer-events: auto;
        }
        #sidebar-overlay.active { display: block; }
        /* Use dynamic viewport to avoid Safari 100vh issues */
        .map-wrapper { position: relative; height: calc(var(--app-vh, 1vh) * 100 - 48px - env(safe-area-inset-bottom, 0px)); padding-bottom: env(safe-area-inset-bottom, 0px); }
        /* Larger touch targets - iOS HIG minimum 44x44px */
        button, input { font-size: 16px; min-height: 44px; }
        #toggle-sidebar, #toggle-sidebar-in { 
          min-width: 44px; 
          min-height: 44px; 
          font-size: 20px;
          border-radius: 6px;
          -webkit-tap-highlight-color: transparent;
          touch-action: manipulation;
        }
        .palette { gap: 10px; }
        .unit-item { min-height: 90px; padding: 12px 8px; }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="sidebar">
        <div style="display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; background:rgba(255,255,255,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index:1; padding:12px; padding-bottom:14px; border-bottom:1px solid rgba(0,0,0,0.1);">
          <strong style="font-size:18px;">Menu</strong>
          <button id="toggle-sidebar-in" aria-label="Close menu" style="background:rgba(0,0,0,0.05); border:none; border-radius:6px; padding:8px 12px;">☰</button>
        </div>
        <div class="section">
          <label><strong>Go To (MGRS)</strong></label>
          <div style="display:flex; gap:6px;">
            <input id="mgrs-input" type="text" placeholder="17S KT 85128 53610" style="flex:1;">
            <button id="goto-location">Go</button>
          </div>
        </div>

        <div class="section controls">
          <button id="measure-distance">Measure Distance</button>
          <button id="add-text">Add Text</button>
          <button id="export-image">Export Image</button>
          <button id="clear-units">Clear Units</button>
        </div>

        <div class="section">
          <strong>Unit Palette</strong>
          <div id="unit-palette" class="palette"></div>
        </div>

        <div class="section">
          <strong>Unit Hierarchy</strong>
          <div id="unit-hierarchy" class="hierarchy"></div>
        </div>

        <div class="section route">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Route Plan</strong>
            <button id="add-route-leg" style="padding:2px 6px;">Add Leg</button>
          </div>
          <div id="route-plan-list" style="margin-top:8px;">
            <div class="route-leg" data-leg="1">
              <input type="text" class="route-from" placeholder="From" style="width: 45px;">
              <span>→</span>
              <input type="text" class="route-to" placeholder="To" style="width: 45px;">
              <span>(</span>
              <input type="number" class="route-distance" placeholder="m" style="width: 50px;">
              <span>m,</span>
              <input type="number" class="route-azimuth" placeholder="°" style="width: 50px;">
              <span>°,</span>
              <input type="text" class="route-direction" placeholder="dir" style="width: 30px;">
              <span>)</span>
              <button class="route-notes-btn" style="margin-left: 3px; padding: 1px 4px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">+</button>
              <button class="route-remove-btn" style="margin-left: 3px; padding: 1px 4px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">-</button>
            </div>
            <div class="route-notes" style="display: none; margin-top: 5px; margin-bottom: 8px;">
              <textarea class="route-notes-text" placeholder="Enter notes for this route leg..." style="width: 100%; height: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
            </div>
          </div>
          <div style="display:none; gap:6px; margin-top:8px;">
            <button id="save-route-plan">Save</button>
            <button id="load-route-plan">Load</button>
            <button id="clear-route-plan">Clear</button>
          </div>
        </div>

        <div class="section">
          <strong>Your Location</strong>
          <div id="your-location-mgrs" style="padding:6px; border:1px solid #ddd; border-radius:4px; margin-top:6px;">—</div>
          <button id="refresh-location" style="margin-top:6px; width:100%;">Refresh Location</button>
        </div>
      </div>

      <div style="display:flex; flex-direction:column;">
        <div id="topbar">
          <button id="toggle-sidebar" aria-label="Open menu">☰</button>
          <div style="font-weight:bold;">Tactical Planner</div>
        </div>
        <div class="map-wrapper" style="position:relative; height:100%;">
          <div id="sidebar-overlay" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.25); z-index:2000;"></div>
        <div class="grid-info">
          <div id="grid-info">Grid: 1km</div>
          <div id="cursor-position">MGRS: —</div>
        </div>
        <div id="tactical-map"></div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mgrs@2.1.0/dist/mgrs.min.js"></script>
    <script>window.mgrs = mgrs;</script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- Firebase Config (you'll update this with your credentials) -->
    <script src="public/js/firebase-config.js"></script>
    <script src="public/js/app-core.js?v=debug"></script>
    <script>
      // Aggressive cache-busting: unregister all old service workers and register fresh
      if ('serviceWorker' in navigator) {
        // Unregister all existing service workers first
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
          }
          // Wait a bit then register fresh with cache-busting
          setTimeout(() => {
            navigator.serviceWorker.register('./service-worker.js?v=' + Date.now(), {
              updateViaCache: 'none'
            }).catch(() => {});
          }, 100);
        });
      }
      
      // Clear localStorage on each load (debug mode)
      try { 
        localStorage.removeItem('tacticalMapState'); 
      } catch(e) {}
      // iOS Safari 100vh fix: set --app-vh to innerHeight
      (function setVh(){
        var set = function(){ document.documentElement.style.setProperty('--app-vh', (window.innerHeight*0.01)+'px'); };
        set();
        window.addEventListener('resize', set);
        window.addEventListener('orientationchange', set);
      })();
      // Sidebar toggle for mobile
      (function(){
        var btn = document.getElementById('toggle-sidebar');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('sidebar-overlay');
        var btnIn = document.getElementById('toggle-sidebar-in');
        function openSidebar(){ 
          sidebar.classList.add('open'); 
          if (overlay) {
            overlay.style.display='block'; 
            overlay.classList.add('active');
          }
        }
        function closeSidebar(){ 
          sidebar.classList.remove('open'); 
          if (overlay) {
            overlay.style.display='none';
            overlay.classList.remove('active');
          }
        }
        if (btn && sidebar) btn.addEventListener('click', function(){
          if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
        });
        if (btnIn) btnIn.addEventListener('click', function(){
          if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
        });
        if (overlay) {
          overlay.addEventListener('click', closeSidebar);
          overlay.addEventListener('touchstart', function(e){
            e.preventDefault();
            e.stopPropagation();
            closeSidebar();
          }, {passive: false});
        }
        // Prevent sidebar touch events from propagating to map
        if (sidebar) {
          sidebar.addEventListener('touchstart', function(e){
            e.stopPropagation();
          }, {passive: false});
          sidebar.addEventListener('touchmove', function(e){
            e.stopPropagation();
          }, {passive: false});
          sidebar.addEventListener('touchend', function(e){
            e.stopPropagation();
          }, {passive: false});
        }
        // Swipe gestures
        var startX=0, startY=0, tracking=false;
        window.addEventListener('touchstart', function(e){
          var t=e.touches[0]; startX=t.clientX; startY=t.clientY; tracking=true;
        }, {passive:true});
        window.addEventListener('touchmove', function(e){
          if(!tracking) return;
        }, {passive:true});
        window.addEventListener('touchend', function(e){
          if(!tracking) return; tracking=false; var dx=(e.changedTouches[0].clientX - startX); var dy=Math.abs(e.changedTouches[0].clientY - startY);
          if (dy < 80) {
            // Open if swipe right from left edge
            if (!sidebar.classList.contains('open') && startX < 24 && dx > 60) { openSidebar(); }
            // Close if swipe left while open
            if (sidebar.classList.contains('open') && dx < -60) { closeSidebar(); }
          }
        }, {passive:true});
      })();
    </script>
  </body>
</html>


